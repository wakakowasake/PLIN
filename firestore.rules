rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 사용자 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 특정 사용자 확인
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 헬퍼 함수: 여행 멤버 또는 소유자 권한 확인
    function isMember(data) {
      return (data.createdBy == request.auth.uid) ||
             (data.members != null && request.auth.uid in data.members) ||
             (data.userId == request.auth.uid);
    }
    
    // 사용자 프로필 문서
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }
    

    // 여행 계획 문서 (Plans)
    match /plans/{planId} {
      // 읽기: 공개 여행이거나 멤버인 경우
      allow read: if (resource != null && resource.data.isPublic == true) || 
                   (isAuthenticated() && isMember(resource.data));
      
      // 생성: 로그인한 사용자
      allow create: if isAuthenticated();
      
      // 수정/삭제: 멤버(권한 있는 사용자)만 가능
      allow update, delete: if isAuthenticated() && isMember(resource.data);
      
      // 헬퍼: 부모(Plan) 문서의 멤버십 확인 (isMember 함수 재활용 불가하므로 논리 복사)
      // 비용: 부모 문서 읽기 1회 발생
      function isParentMember() {
        let parentData = get(/databases/$(database)/documents/plans/$(planId)).data;
        return (parentData.createdBy == request.auth.uid) ||
               (parentData.members != null && request.auth.uid in parentData.members) ||
               (parentData.userId == request.auth.uid);
      }

      // 타임라인 아이템 서브컬렉션
      match /timeline/{itemId} {
        // [Security Hardening] 부모 Plan의 멤버만 접근 가능하도록 변경
        allow read, write: if isAuthenticated() && isParentMember();
      }
      
      // 추억 서브컬렉션
      match /memories/{memoryId} {
        // [Security Hardening] 부모 Plan의 멤버만 접근 가능하도록 변경
        allow read, write: if isAuthenticated() && isParentMember();
      }
    }
    
    // 공유 링크 (읽기 전용 공유)
    match /sharedTrips/{shareId} {
      allow read: if true;
      // 생성: 로그인 사용자 (누구나 공유 링크 생성 가능)
      allow create: if isAuthenticated();
      // 수정/삭제: 본인이 만든 링크만 (resource.data.createdBy 확인 필요)
      allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
