rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 사용자 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 특정 사용자 확인
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 헬퍼 함수: 여행 소유자 또는 공유 받은 사용자 확인
    function canAccessTrip(tripData) {
      return isAuthenticated() && (
        request.auth.uid == tripData.userId ||
        (tripData.sharedWith != null && request.auth.uid in tripData.sharedWith)
      );
    }
    
    // 사용자 프로필 문서
    match /users/{userId} {
      // 읽기: 로그인한 사용자 누구나 가능 (멤버 목록 표시용)
      allow read: if isAuthenticated();
      // 쓰기: 본인만 가능
      allow write: if isUser(userId);
    }
    
    // 여행 계획 문서 (Plans)
    match /plans/{planId} {
      // 읽기: 로그인한 사용자 OR 공개 설정된 여행
      allow read: if isAuthenticated() || (resource.data.isPublic == true);
      
      // 생성: 로그인한 사용자
      allow create: if isAuthenticated();
      
      // 수정: 로그인한 사용자 (목록 합류를 위해 본인 추가 허용 필요)
      // 보안 강화 필요 시: 기존 멤버이거나, 멤버에 자신을 추가하는 경우만 허용하도록 로직 복잡화 가능
      allow update: if isAuthenticated();
      
      // 삭제: 로그인한 사용자 (실제로는 멤버 여부 체크 권장)
      allow delete: if isAuthenticated();
      
      // 타임라인 아이템 서브컬렉션
      match /timeline/{itemId} {
        allow read, write: if isAuthenticated();
      }
      
      // 추억 서브컬렉션
      match /memories/{memoryId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // 공유 링크 (읽기 전용 공유)
    match /sharedTrips/{shareId} {
      // 공유 링크로 접근한 경우 읽기 가능
      allow read: if true;
      
      // 생성/수정/삭제는 인증된 사용자만
      allow create, update, delete: if isAuthenticated();
    }
    
    // 기본적으로 모든 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
