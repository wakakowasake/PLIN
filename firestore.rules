rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 사용자 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 특정 사용자 확인
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 헬퍼 함수: 여행 멤버 또는 소유자 권한 확인
    function isMember(data) {
      return (data.createdBy == request.auth.uid) ||
             (data.members != null && request.auth.uid in data.members) ||
             (data.userId == request.auth.uid);
    }
    
    // 사용자 프로필 문서
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }
    
    // 여행 계획 문서 (Plans)
    match /plans/{planId} {
      // 읽기: 공개 여행이거나 멤버인 경우
      allow read: if (resource != null && resource.data.isPublic == true) || 
                   (isAuthenticated() && isMember(resource.data));
      
      // 생성: 로그인한 사용자
      allow create: if isAuthenticated();
      
      // 수정/삭제: 멤버(권한 있는 사용자)만 가능
      allow update, delete: if isAuthenticated() && isMember(resource.data);
      
      // 타임라인 아이템 서브컬렉션
      match /timeline/{itemId} {
        // [Security] 엄격하게 가려면 plans 문서를 get()으로 확인해야 함
        // 비용 절감을 위해 일단 로그인 체크 위주로 유지 (ID가 유추하기 매우 어려움)
        allow read, write: if isAuthenticated();
      }
      
      // 추억 서브컬렉션
      match /memories/{memoryId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // 공유 링크 (읽기 전용 공유)
    match /sharedTrips/{shareId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated();
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
